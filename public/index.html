<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sim Exchange</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0e11;
      color: #eaecef;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: #11161c;
      border-bottom: 1px solid #1f2a35;
    }
    header .left {
      font-size: 16px;
      font-weight: bold;
    }
    header .right {
      font-size: 14px;
      opacity: 0.9;
    }
    header span {
      margin-left: 14px;
    }

    .container {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
      padding: 14px;
    }

    .card {
      background: #11161c;
      border: 1px solid #1f2a35;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    h2 {
      margin: 8px 0 10px;
      font-size: 16px;
      border-bottom: 1px solid #1f2a35;
      padding-bottom: 8px;
    }

    ul { margin: 0; padding-left: 18px; }
    li { margin: 6px 0; }

    input {
      width: 140px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #2b3a4a;
      background: #0b0e11;
      color: #eaecef;
    }
    button {
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      background: #f0b90b;
      cursor: pointer;
      font-weight: bold;
      margin-left: 6px;
    }
    button:hover { opacity: 0.9; }

    .row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: #0b0e11;
      border: 1px solid #1f2a35;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .bottom {
      padding: 0 14px 14px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .muted { opacity: 0.8; font-size: 13px; }
    .ok { color: #0ecb81; }
    .bad { color: #f6465d; }
  </style>
</head>
<body>

<header>
  <div class="left">Sim Exchange</div>
  <div class="right">
    <span>Account: <b id="accountName">demo</b></span>
    <span>USDT Balance: <b id="usdtTop">--</b></span>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>Available Coins</h2>
    <ul id="coins"></ul>
    <p class="muted">Prices can be manual or from public market API.</p>
  </div>

  <div class="card">
    <h2>Trade (Demo)</h2>

    <div class="row">
      <div><b>Buy BTC</b></div>
      <input id="buyAmount" type="number" value="0.01" step="0.01">
      <button onclick="buyBTC()">Buy</button>
    </div>

    <div class="row">
      <div><b>Sell BTC</b></div>
      <input id="sellAmount" type="number" value="0.01" step="0.01">
      <button onclick="sellBTC()">Sell</button>
    </div>

    <h2>Deposit Request</h2>
    <div class="row">
      <input id="depositAmount" type="number" value="100" step="1">
      <button onclick="depositRequest()">Submit</button>
    </div>

    <h2>Withdraw Request</h2>
    <div class="row">
      <input id="withdrawAmount" type="number" value="50" step="1">
      <button onclick="withdrawRequest()">Submit</button>
    </div>

    <div id="result" class="result">Ready.</div>
  </div>
</div>

<div class="bottom">
  <div class="card">
    <h2>Balance</h2>
    <ul id="balance"></ul>
  </div>

  <div class="card">
    <h2>Requests</h2>
    <h3 style="margin:6px 0;">Deposit Requests</h3>
    <ul id="depositList"></ul>

    <h3 style="margin:12px 0 6px;">Withdraw Requests</h3>
    <ul id="withdrawList"></ul>
  </div>

  <div class="card" style="grid-column: 1 / -1;">
    <h2>Transaction History</h2>
    <ul id="tx"></ul>
  </div>
</div>

<script>
  // ✅ Generic helper
  function showResult(obj) {
    document.getElementById("result").innerText =
      typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  // ✅ Load coins
  async function loadCoins() {
    const res = await fetch("/api/coins");
    const coins = await res.json();
    document.getElementById("coins").innerHTML =
      coins.map(c => `<li>${c.symbol} - ${c.price} USDT</li>`).join("");
  }

  // ✅ Load balances + top USDT
  async function loadBalance() {
    const res = await fetch("/api/balance");
    const bal = await res.json();

    document.getElementById("balance").innerHTML =
      bal.map(b => `<li>${b.coin_symbol}: ${b.amount}</li>`).join("");

    const usdt = bal.find(x => x.coin_symbol === "USDT");
    document.getElementById("usdtTop").innerText = usdt ? usdt.amount : "0";
  }

  // ✅ Buy BTC
  async function buyBTC() {
    const amount = parseFloat(document.getElementById("buyAmount").value);
    const res = await fetch("/api/buy", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ symbol: "BTC", amount })
    });
    const data = await res.json();
    showResult(data);
    loadBalance();
    loadTx();
  }

  // ✅ Sell BTC
  async function sellBTC() {
    const amount = parseFloat(document.getElementById("sellAmount").value);
    const res = await fetch("/api/sell", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ symbol: "BTC", amount })
    });
    const data = await res.json();
    showResult(data);
    loadBalance();
    loadTx();
  }

  // ✅ Deposit request
  async function depositRequest() {
    const requested_amount = parseFloat(document.getElementById("depositAmount").value);
    const res = await fetch("/api/deposit-request", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ coin_symbol: "USDT", requested_amount })
    });
    const data = await res.json();
    showResult(data);
    loadDeposits();
  }

  // ✅ Withdraw request
  async function withdrawRequest() {
    const requested_amount = parseFloat(document.getElementById("withdrawAmount").value);
    const res = await fetch("/api/withdraw-request", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ coin_symbol: "USDT", requested_amount })
    });
    const data = await res.json();
    showResult(data);
    loadWithdraws();
  }

  // ✅ Load deposit list
  async function loadDeposits() {
    const res = await fetch("/api/deposit-requests");
    const list = await res.json();
    document.getElementById("depositList").innerHTML =
      list.map(d => `<li>#${d.id} ${d.coin_symbol} ${d.requested_amount} - <b>${d.status}</b></li>`).join("");
  }

  // ✅ Load withdraw list
  async function loadWithdraws() {
    const res = await fetch("/api/withdraw-requests");
    const list = await res.json();
    document.getElementById("withdrawList").innerHTML =
      list.map(w => `<li>#${w.id} ${w.coin_symbol} ${w.requested_amount} - <b>${w.status}</b></li>`).join("");
  }

  // ✅ Load transaction history
  async function loadTx() {
    const res = await fetch("/api/transactions");
    const tx = await res.json();
    document.getElementById("tx").innerHTML =
      tx.map(t => {
        const type = (t.type || "").toUpperCase();
        if (type === "DEPOSIT") return `<li>#${t.id} <span class="ok">DEPOSIT</span> ${t.coin_symbol} +${t.amount} (total: ${t.total})</li>`;
        if (type === "WITHDRAW") return `<li>#${t.id} <span class="bad">WITHDRAW</span> ${t.coin_symbol} -${t.amount} (total: ${t.total})</li>`;
        if (type === "BUY") return `<li>#${t.id} BUY ${t.coin_symbol} ${t.amount} @ ${t.price} = ${t.total}</li>`;
        if (type === "SELL") return `<li>#${t.id} SELL ${t.coin_symbol} ${t.amount} @ ${t.price} = ${t.total}</li>`;
        return `<li>#${t.id} ${type} ${t.coin_symbol} ${t.amount}</li>`;
      }).join("");
  }

  // ✅ Initial load
  loadCoins();
  loadBalance();
  loadDeposits();
  loadWithdraws();
  loadTx();

  // ✅ auto refresh top balance every 5s
  setInterval(loadBalance, 5000);
</script>

</body>
</html>
