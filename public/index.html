<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sim Exchange</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0e11;
      color: #eaecef;
    }
    header {
      height: 50px;
      background: #101418;
      display: flex;
      align-items: center;
      padding: 0 16px;
      justify-content: space-between;
      border-bottom: 1px solid #222;
    }
    header .left {
      font-weight: bold;
      font-size: 16px;
    }
    header .right {
      font-size: 14px;
      opacity: 0.9;
    }

    .container {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      grid-template-rows: auto 260px 260px;
      gap: 12px;
      padding: 12px;
    }

    .card {
      background: #101418;
      border: 1px solid #1f2a37;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02);
    }

    .markets { grid-row: 1 / span 3; }
    .chart { grid-row: 1 / span 2; }
    .trade { grid-row: 1 / span 1; }
    .requests { grid-row: 2 / span 1; grid-column: 3; }
    .history { grid-row: 3; grid-column: 2 / span 2; }

    h2 {
      font-size: 16px;
      margin: 0 0 10px;
      font-weight: bold;
    }
    .muted { opacity: 0.7; font-size: 12px; }

    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-weight: bold;
      background: #f0b90b;
      color: #111;
    }
    button:hover { opacity: 0.9; }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #2a3645;
      background: #0b0e11;
      color: #eaecef;
      box-sizing: border-box;
    }

    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .row label { width: 70px; font-size: 13px; }
    .row input { flex: 1; }
    .row button { width: 90px; }

    ul { margin: 0; padding-left: 18px; }
    li { margin-bottom: 6px; }

    .intervals {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .intervals button {
      background: #0b0e11;
      color: #eaecef;
      border: 1px solid #2a3645;
      padding: 6px 12px;
      font-weight: normal;
    }
    .intervals button.active {
      background: #f0b90b;
      color: #111;
      font-weight: bold;
    }

    #chartContainer {
      height: 420px;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">Sim Exchange</div>
    <div class="right">Account: demo <span id="topBalance"></span></div>
  </header>

  <div class="container">
    <!-- MARKETS -->
    <div class="card markets">
      <h2>Markets</h2>
      <p class="muted">Click a coin to view chart.</p>
      <ul id="coins"></ul>
    </div>

    <!-- CHART -->
    <div class="card chart">
      <h2 id="pairTitle">BTC/USDT</h2>

      <div class="intervals" id="intervalButtons">
        <button class="active" data-interval="1m">1m</button>
        <button data-interval="5m">5m</button>
        <button data-interval="15m">15m</button>
        <button data-interval="1h">1h</button>
        <button data-interval="4h">4h</button>
        <button data-interval="1d">1d</button>
      </div>

      <div id="chartContainer"></div>
    </div>

    <!-- TRADE -->
    <div class="card trade">
      <h2>Trade <span class="muted">(Demo)</span></h2>

      <div class="row">
        <label>Buy</label>
        <input id="buyAmount" type="number" value="0.01" step="0.01">
        <button onclick="buyBTC()">Buy</button>
      </div>

      <div class="row">
        <label>Sell</label>
        <input id="sellAmount" type="number" value="0.01" step="0.01">
        <button onclick="sellBTC()">Sell</button>
      </div>

      <h2>Deposit Request</h2>
      <div class="row">
        <input id="depositAmount" type="number" value="100">
        <button onclick="depositRequest()">Submit</button>
      </div>

      <h2>Withdraw Request</h2>
      <div class="row">
        <input id="withdrawAmount" type="number" value="50">
        <button onclick="withdrawRequest()">Submit</button>
      </div>

      <p id="result" class="muted">Ready.</p>
    </div>

    <!-- REQUEST LIST -->
    <div class="card requests">
      <h2>Requests</h2>
      <h3 class="muted">Deposit Requests</h3>
      <ul id="depositList"></ul>
      <h3 class="muted">Withdraw Requests</h3>
      <ul id="withdrawList"></ul>
    </div>

    <!-- HISTORY -->
    <div class="card history">
      <h2>Transaction History</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- ✅ 本地 lightweight-charts -->
  <script src="/js/lightweight-charts.js"></script>

  <script>
    let currentSymbol = "BTCUSDT";
    let currentInterval = "1m";
    let chart, candleSeries;

    async function loadCoins() {
      const res = await fetch("/api/coins");
      const coins = await res.json();

      document.getElementById("coins").innerHTML =
        coins.map(c => `<li style="cursor:pointer" onclick="selectCoin('${c.symbol}USDT')">${c.symbol}/USDT</li>`).join("");
    }

    async function loadBalance() {
      const res = await fetch("/api/balance");
      const bal = await res.json();

      document.getElementById("topBalance").innerText =
        " | USDT: " + (bal.find(x => x.coin_symbol === "USDT")?.amount || 0);

    }

    async function loadRequests() {
      const depRes = await fetch("/api/deposit-requests");
      const dep = await depRes.json();
      document.getElementById("depositList").innerHTML =
        dep.map(d => `<li>#${d.id} ${d.coin_symbol} ${d.requested_amount} - ${d.status}</li>`).join("");

      const wdRes = await fetch("/api/withdraw-requests");
      const wd = await wdRes.json();
      document.getElementById("withdrawList").innerHTML =
        wd.map(w => `<li>#${w.id} ${w.coin_symbol} ${w.requested_amount} - ${w.status}</li>`).join("");
    }

    async function loadHistory() {
      const res = await fetch("/api/transactions");
      const data = await res.json();
      document.getElementById("historyList").innerHTML =
        data.map(t => `<li>#${t.id} ${t.type.toUpperCase()} ${t.coin_symbol} ${t.amount} (total: ${t.total})</li>`).join("");
    }

    function initChart() {
      chart = LightweightCharts.createChart(document.getElementById("chartContainer"), {
        width: document.getElementById("chartContainer").clientWidth,
        height: 420,
        layout: { background: { color: "#101418" }, textColor: "#eaecef" },
        grid: { vertLines: { color: "#1f2a37" }, horzLines: { color: "#1f2a37" } },
        timeScale: { borderColor: "#2a3645" },
      });

      candleSeries = chart.addCandlestickSeries();
    }

    async function loadKlines() {
      const res = await fetch(`/api/klines?symbol=${currentSymbol}&interval=${currentInterval}&limit=200`);
      const data = await res.json();
      candleSeries.setData(data);
    }

    function selectCoin(symbol) {
      currentSymbol = symbol;
      document.getElementById("pairTitle").innerText = symbol.replace("USDT", "") + "/USDT";
      loadKlines();
    }

    document.getElementById("intervalButtons").addEventListener("click", (e) => {
      if (e.target.tagName !== "BUTTON") return;

      document.querySelectorAll("#intervalButtons button").forEach(b => b.classList.remove("active"));
      e.target.classList.add("active");

      currentInterval = e.target.dataset.interval;
      loadKlines();
    });

    async function buyBTC() {
      const amount = parseFloat(document.getElementById("buyAmount").value);
      const res = await fetch("/api/buy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol: "BTC", amount })
      });

      const data = await res.json();
      document.getElementById("result").innerText = JSON.stringify(data);
      loadBalance();
      loadHistory();
    }

    async function sellBTC() {
      const amount = parseFloat(document.getElementById("sellAmount").value);
      const res = await fetch("/api/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol: "BTC", amount })
      });

      const data = await res.json();
      document.getElementById("result").innerText = JSON.stringify(data);
      loadBalance();
      loadHistory();
    }

    async function depositRequest() {
      const requested_amount = parseFloat(document.getElementById("depositAmount").value);

      const res = await fetch("/api/deposit-request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ coin_symbol: "USDT", requested_amount })
      });

      const data = await res.json();
      document.getElementById("result").innerText = JSON.stringify(data);
      loadRequests();
    }

    async function withdrawRequest() {
      const requested_amount = parseFloat(document.getElementById("withdrawAmount").value);

      const res = await fetch("/api/withdraw-request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ coin_symbol: "USDT", requested_amount, address: "0x123..." })
      });

      const data = await res.json();
      document.getElementById("result").innerText = JSON.stringify(data);
      loadRequests();
    }

    // ✅ init
    initChart();
    loadCoins();
    loadBalance();
    loadRequests();
    loadHistory();
    loadKlines();
  </script>
</body>
</html>
